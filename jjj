<?php
session_start();
/** Appelle du fichier de conexion de la base de données" */
require "connexion.php";

/** Déclaration des variables contenant les informations entrées par l'utilisateur */
@$nom = $_POST['nom'];
@$postnom = $_POST['postnom'];
@$prenom = $_POST['prenom'];
@$email = $_POST['email'];
@$phone = $_POST['phone'];

/** Verifier si le button s'inscrire est cliqué" */
if (isset($_POST['subscribe'])) {



    /** Verifier si les champs sont envoyés et qu'ils ne sont pas vides" */
    if (
        isset($nom, $postnom, $prenom, $email, $phone) && !empty($nom) && !empty($postnom) && !empty($email)
        && !empty($phone)
    ) {

        /** Suppression des balises HTML et PHP */
        $nom = strip_tags($_POST['nom']);
        $postnom = strip_tags($_POST['postnom']);
        $prenom = strip_tags($_POST['prenom']);
        $email = strip_tags($_POST['email']);
        $phone = strip_tags($_POST['phone']);

        /** Verifier si l'utilisateur a entré une adresse mail valide" */
        $_SESSION["erreur"] = [];
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {

            $_SESSION['error'][] = "Adresse Email Invalide";
        }


        /** Verifie si le compte existe dèja dans dans la BDD */

        $select = "SELECT * FROM `inscription` WHERE `email` = '$email'";
        $query = $dataBase->query($select);
        $count_Exist = $query->fetch(PDO::FETCH_ASSOC);

        if ($count_Exist) {
            $_SESSION['error'][] = "Ces informations existent dèja dans notre base de données, elles ont dèja été inscrites";
        }


        if ($_SESSION['error'] == []) {
            /** Requête SQL pour insérer les données dans la BDD */
            $inscription = "INSERT INTO `inscription`(`Nom`, `Post-nom`, `Prenom`, `Email`, `Telephone`)
     VALUES(:nom, :postnom, :prenom, :email, :phone)";

            /** Preparation de la requête */
            $prepare = $dataBase->prepare($inscription);

            /** Execution de la Requête en passant les données dans un tableau */
            $execute = $prepare->execute(array(":nom" => $nom, ":postnom" => $postnom, ":prenom" => $prenom, ":email" => $email, ":phone" => $phone));


            if ($execute) {
                $_SESSION['user'] = [
                    "nom" => $nom,
                    "postnom" => $postnom,
                    "prenom" => $prenom
                ];
                header("location: success_insciption.php");
            }
        }
    } else {
        $_SESSION['error'] = ["veillez remplir tous les champs svp"];
    }
}
?>

<?php require "header.php" ?>

<div class="row" id="activities">
    <div class="col-xs-12">
        <h3 class="sub-heading">Inscriptions</h3>
        <div class="rule heading-rule">
            <hr>
        </div>
        <div class="container">
            <form method="POST">
                <?php if (isset($_SESSION['error'])) {
                    foreach ($_SESSION['error'] as $error) {
                ?>
                        <div class="alert alert-danger" role="alert">
                            <?php echo $error ?>
                        </div>
                <?php
                    }
                    unset($_SESSION['error']);
                }
                ?>
                <div class="mb-3">
                    <label for="nom" class="form-label">Nom</label>
                    <input type="text" class="form-control" id="nom" name="nom">
                </div>
                <div class="mb-3">
                    <label for="postnom" class="form-label">Post-nom</label>
                    <input type="text" class="form-control" id="postnom" name="postnom">
                </div>
                <div class="mb-3">
                    <label for="prenom" class="form-label">Prenom</label>
                    <input type="text" class="form-control" id="prenom" name="prenom">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Adresse Email</label>
                    <input type="text" class="form-control" id="email" placeholder="name@example.com" name="email">
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Numero de Télephone</label>
                    <input type="number" class="form-control" id="phone" name="phone">
                </div>
                <div class="mb-3">
                    <button type="submit" class="w-100 p-2" style="background-color: #248f7e; color : white; border:none" class="btn btn-subscribe mb-3" name="subscribe">S'inscrire</button>
                </div>
            </form>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>


        <?php require "footer.php" ?>